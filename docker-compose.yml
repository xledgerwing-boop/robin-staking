version: '3.8'

# Enable BuildKit for better caching
x-build-args: &build-args
    BUILDKIT_INLINE_CACHE: 1

services:
    # TimescaleDB (PostgreSQL with TimescaleDB extension)
    timescaledb:
        image: timescale/timescaledb:latest-pg15
        container_name: yield-robin-timescaledb
        environment:
            POSTGRES_DB: stake_robin
            POSTGRES_USER: stake_robin_user
            POSTGRES_PASSWORD: stake_robin_password
        ports:
            - '5432:5432'
        volumes:
            - timescaledb_data:/var/lib/postgresql/data
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U stake_robin_user -d stake_robin']
            interval: 10s
            timeout: 5s
            retries: 5

    # Frontend service
    frontend:
        build:
            context: .
            dockerfile: Dockerfile.frontend
            args:
                <<: *build-args
        container_name: yield-robin-frontend
        environment:
            POSTGRES_URI: postgresql://stake_robin_user:stake_robin_password@timescaledb:5432/stake_robin
            NODE_ENV: production
            NODE_OPTIONS: '--max-old-space-size=2048'
            ANALYTICS: ${ANALYTICS}
            ADMIN_PASSWORD: ${ADMIN_PASSWORD}
        ports:
            - '3000:3000'
        depends_on:
            timescaledb:
                condition: service_healthy
        healthcheck:
            test: ['CMD-SHELL', 'curl -f http://localhost:3000/api/health']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
        restart: unless-stopped

volumes:
    timescaledb_data:
        driver: local
