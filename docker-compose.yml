version: '3.8'

# Enable BuildKit for better caching
x-build-args: &build-args
    BUILDKIT_INLINE_CACHE: 1

services:
    # TimescaleDB (PostgreSQL with TimescaleDB extension)
    timescaledb:
        image: timescale/timescaledb:latest-pg17
        container_name: robin-pm-staking-timescaledb
        environment:
            POSTGRES_DB: stake_robin
            POSTGRES_USER: stake_robin_user
            POSTGRES_PASSWORD: stake_robin_password
        ports:
            - '5433:5432'
        volumes:
            - timescaledb_data:/var/lib/postgresql/data
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U stake_robin_user -d stake_robin']
            interval: 10s
            timeout: 5s
            retries: 5

    # Indexer service
    indexer:
        build:
            context: .
            dockerfile: Dockerfile.indexer
            args:
                <<: *build-args
        container_name: robin-pm-staking-indexer
        environment:
            POSTGRES_URI: postgresql://stake_robin_user:stake_robin_password@timescaledb:5432/stake_robin
            TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
            TELEGRAM_GROUP_CHAT_ID: ${TELEGRAM_GROUP_CHAT_ID}
            RPC_URL: ${RPC_URL}
            RPC_CHAIN_ID: ${RPC_CHAIN_ID}
            INDEXER_TYPE: ${INDEXER_TYPE:-streams}
            QUICKNODE_SECURITY_TOKEN: ${QUICKNODE_SECURITY_TOKEN}
            WEBHOOK_PORT: 3000
        ports:
            - '3003:3000'
        depends_on:
            timescaledb:
                condition: service_healthy
        healthcheck:
            test: ['CMD-SHELL', 'curl -f http://localhost:3003/health']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
        restart: no

    # Frontend service
    frontend:
        build:
            context: .
            dockerfile: Dockerfile.frontend
            args:
                <<: *build-args
        container_name: robin-pm-staking-frontend
        environment:
            POSTGRES_URI: postgresql://stake_robin_user:stake_robin_password@timescaledb:5432/stake_robin
            NODE_ENV: production
            NODE_OPTIONS: '--max-old-space-size=2048'
            ANALYTICS: ${ANALYTICS}
        ports:
            - '3002:3000'
        depends_on:
            timescaledb:
                condition: service_healthy
        healthcheck:
            test: ['CMD-SHELL', 'curl -f http://localhost:3002/api/health']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
        restart: unless-stopped

volumes:
    timescaledb_data:
        driver: local
